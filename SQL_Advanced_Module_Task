--metrics by account
WITH account_metrics AS (
  SELECT
    date,
    sp.country,
    send_interval,
    is_verified,
    is_unsubscribed,
    COUNT(DISTINCT id) AS account_cnt 
  FROM
    `data-analytics-mate.DA.account` acc
  JOIN
    `data-analytics-mate.DA.account_session` accs
  ON
    accs.account_id = acc.id
  JOIN
    `data-analytics-mate.DA.session_params` sp
  ON
    sp.ga_session_id = accs.ga_session_id
  JOIN
    `data-analytics-mate.DA.session` s
  ON
    s.ga_session_id = accs.ga_session_id
  GROUP BY
    date,
    country,
    send_interval,
    is_verified,
    is_unsubscribed),

--email metrics
  email_metrics AS (
  SELECT
    DATE_ADD(s.date, INTERVAL es.sent_date DAY) AS date,
    country,
    send_interval,
    is_verified,
    is_unsubscribed,
    COUNT(DISTINCT es.id_message) AS sent_msg,
    COUNT(DISTINCT eo.id_message)AS open_msg,
    COUNT(DISTINCT ev.id_message) AS visit_msg,
  FROM
    `data-analytics-mate.DA.account_session` accs
  JOIN
    `data-analytics-mate.DA.session` s
  ON
    s.ga_session_id = accs.ga_session_id
  JOIN
    `data-analytics-mate.DA.account` acc
  ON
    acc.id = accs.account_id
  JOIN
    `data-analytics-mate.DA.session_params` sp
  ON
    sp.ga_session_id = accs.ga_session_id
  JOIN
    `data-analytics-mate.DA.email_sent` es
  ON
    es.id_account = accs.account_id
  LEFT JOIN
    `data-analytics-mate.DA.email_open` eo
  ON
    eo.id_message = es.id_message
  LEFT JOIN
    `data-analytics-mate.DA.email_visit` ev
  ON
    ev.id_message = es.id_message
  GROUP BY
    date,
    country,
    send_interval,
    is_verified,
    is_unsubscribed),

--data merging
  union_all AS (
    SELECT
    DISTINCT date,
    am.country,
    send_interval,
    is_verified,
    is_unsubscribed,
    account_cnt ,
    0 AS sent_msg,
    0 AS open_msg,
    0 AS visit_msg
  FROM
    account_metrics AS am
  UNION ALL
  SELECT
    DISTINCT date,
    em.country,
    send_interval,
    is_verified,
    is_unsubscribed,
    0 AS account_cnt ,
    sent_msg,
    open_msg,
    visit_msg,
  FROM
    email_metrics em

),
  total_data AS (
  SELECT
    date,
    ua.country,
    send_interval,
    is_verified,
    is_unsubscribed,
    SUM(account_cnt ) AS account_cnt ,
    SUM(sent_msg) AS sent_msg,
    SUM(open_msg) AS open_msg,
    SUM(visit_msg) AS visit_msg
  FROM
    union_all ua
  GROUP BY
    date,
    ua.country,
    send_interval,
    is_verified,
    is_unsubscribed),

--data grouping
  final_groups AS (
  SELECT
    *,
    SUM(account_cnt ) OVER (PARTITION BY country) AS total_country_account_cnt ,
    SUM(sent_msg) OVER (PARTITION BY country) AS total_country_sent_cnt,
  FROM
    total_data),
  
--data ranking
  total_with_rank AS (
  SELECT
    *,
    DENSE_RANK() OVER (ORDER BY total_country_account_cnt  DESC) AS rank_total_country_account_cnt ,
    DENSE_RANK() OVER (ORDER BY total_country_sent_cnt DESC) AS rank_total_country_sent_cnt
  FROM
    final_groups )
    
--final request
SELECT
  *
FROM
  total_with_rank
WHERE
  rank_total_country_account_cnt  <= 10
  OR rank_total_country_sent_cnt <= 10
